package rip.hippo.mosey.transformer.impl.exploits

import org.objectweb.asm.tree._
import rip.hippo.mosey.asm.wrapper.ClassWrapper
import rip.hippo.mosey.transformer.Transformer
import org.objectweb.asm.Opcodes._


/**
 * @author Hippo
 * @version 1.0.0, 7/29/20
 * @since 1.3.0
 *
 *  This inserts a jump instruction that is out side of the code attributes range,
 *  this will cause unmodified ASM to crash.
 *  Definitely did not take the idea from paramorphism or anything.
 *  WARNING: Requires -noverify
 */
final class InvalidJumpRangeTransformer extends Transformer {

  override def transform(classWrapper: ClassWrapper): Unit = {
    val insnList = new InsnList
    val label = new LabelNode
    insnList.add(new InsnNode(ACONST_NULL))
    insnList.add(new JumpInsnNode(IFNULL, label))
    insnList.add(new InsnNode(GOTO))
    insnList.add(label)
    classWrapper.methods.foreach(_.getInstructions.insert(insnList))
  }
}
